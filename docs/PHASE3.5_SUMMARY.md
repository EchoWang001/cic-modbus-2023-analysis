# Phase 3.5 补充实验完整总结

> **执行时间**: 2026-01-22
> 
> **实验目的**: 基于Phase 3发现的`consecutive_write_max`特征高效性，补充关键实验以完善论文论证

---

## 一、实验背景

### Phase 3 关键发现回顾

在Phase 3核心验证实验中，我们发现了一个重要现象：

- **SCADA场景**: Attack样本 cwm>0 = 100%, Normal样本 cwm>0 = 0%
- **IED场景**: Attack样本 cwm>0 = 100%, Normal样本 cwm>0 = 0%
- 简单规则 `consecutive_write_max > 0` 可能已接近最优检测性能

这一发现促使我们设计Phase 3.5补充实验，以：
1. 正式量化简单规则的性能基线
2. 分析cwm特征对ML模型的实际贡献
3. 深入理解误判样本的特征分布

---

## 二、实验内容与结果

### E13: 简单规则基线完整评估

#### 实验目的
量化简单规则 `consecutive_write_max > 0` 的检测能力，作为所有ML方法的baseline。

#### 数据集信息
- **训练+验证集**: 98,449 样本
- **测试集**: 19,760 样本
  - Normal: 18,648
  - Attack: 1,112

#### 测试集cwm分布分析

| 类别 | cwm>0占比 | cwm>1占比 | cwm均值 | cwm最大值 |
|------|-----------|-----------|---------|-----------|
| Attack (n=1,112) | 100.0% | 99.6% | 37.01 | 2609 |
| Normal (n=18,648) | 2.9% | - | 0.06 | 2 |

#### 简单规则性能 (cwm > 0)

| 指标 | 数值 |
|------|------|
| Accuracy | 0.9731 |
| Precision | 0.6764 |
| Recall | **1.0000** |
| F1 | 0.8070 |

**混淆矩阵**:
```
              预测Normal  预测Attack
实际Normal      18,116       532
实际Attack           0     1,112
```

- **TP**: 1,112 (所有Attack正确识别)
- **FN**: 0 (零漏检)
- **FP**: 532 (误报)
- **TN**: 18,116

#### 简单规则 vs ML方法对比

| 方法 | Accuracy | Precision | Recall | F1 | 推理时间(ms) | 模型大小(MB) |
|------|----------|-----------|--------|----|--------------| -------------|
| 简单规则 (cwm>0) | 0.9731 | 0.6764 | **1.0000** | 0.8070 | 0.0001 | 0.00 |
| Random Forest | 0.9921 | 0.9484 | 0.9083 | 0.9279 | 0.0065 | 9.99 |
| XGBoost | **0.9958** | **0.9886** | 0.9361 | **0.9617** | 0.0011 | 0.24 |

#### ML方法相对于简单规则的增益

| 模型 | F1增益 | 相对提升 | Precision变化 | Recall变化 |
|------|--------|----------|---------------|------------|
| Random Forest | +0.1209 | +14.98% | +0.2720 | -0.0917 |
| XGBoost | +0.1547 | +19.17% | +0.3122 | -0.0639 |

**结论**: ML方法通过牺牲少量Recall换取大幅Precision提升，整体F1显著优于简单规则。

#### 分场景评估 (简单规则 cwm>0)

| 场景 | 样本数 | Attack | Normal | Accuracy | Precision | Recall | F1 |
|------|--------|--------|--------|----------|-----------|--------|-----|
| benign | 44,821 | 0 | 44,821 | 0.9058 | - | - | - |
| scada | 38,799 | 3,811 | 34,988 | **1.0000** | **1.0000** | **1.0000** | **1.0000** |
| ied | 34,582 | 1,400 | 33,182 | **1.0000** | **1.0000** | **1.0000** | **1.0000** |

**重要发现**: 
- 简单规则在SCADA和IED场景中表现完美 (F1=1.0)
- 所有FP (532个) 均来自benign场景

---

### E14: 排除cwm特征分析

#### 实验目的
分析`consecutive_write_max`相关特征对ML模型的实际贡献度。

#### 特征组定义
- **全部特征**: 44个
- **排除cwm**: 41个 (移除 `consecutive_write_max`, `consecutive_write_mean`, `write_burst_count`)
- **仅协议层**: 13个

#### 5-Fold交叉验证结果 (Random Forest)

| 特征组 | 特征数 | CV F1 (Mean±Std) | Test F1 |
|--------|--------|------------------|---------|
| 全部特征 | 44 | 0.9491±0.0048 | 0.9279 |
| 排除cwm | 41 | 0.9509±0.0043 | 0.9265 |
| 仅协议层 | 13 | 0.9534±0.0054 | 0.9221 |

#### cwm特征贡献分析

| 指标 | 全部特征 | 排除cwm | 差异 |
|------|----------|---------|------|
| CV F1 | 0.9491 | 0.9509 | -0.0018 |
| Test F1 | 0.9279 | 0.9265 | **+0.0014** |

**cwm特征对ML模型的增量贡献**: F1变化 = +0.15%

**结论**: 
- cwm相关特征对ML模型的增量贡献极小 (+0.15%)
- ML模型已从其他特征中学习到足够的判别信息
- 简单规则的有效性主要体现在规则本身，而非为ML提供特征

---

### E15: 规则阈值调整实验

#### 实验目的
探索不同cwm阈值对规则性能的影响，寻找最佳阈值。

#### 阈值扫描结果

| 阈值 | Precision | Recall | F1 | Attack覆盖率 |
|------|-----------|--------|-----|--------------|
| cwm > 0 | 0.6764 | 1.0000 | 0.8070 | 100.00% |
| **cwm > 1** | **0.6859** | **0.9955** | **0.8125** | **99.55%** |
| cwm > 2 | 0.9412 | 0.0719 | 0.1337 | 7.19% |
| cwm > 5 | 0.9744 | 0.0341 | 0.0659 | 3.42% |

**最佳阈值**: cwm > 1
- F1 = 0.8125 (提升0.68%)
- Attack覆盖率 = 99.55%

**结论**: 
- cwm > 1 略优于 cwm > 0，但提升有限
- 阈值过高会急剧降低Recall
- 简单规则对阈值敏感，适用范围受限

---

### E9: 误判分析实验

#### 实验目的
深入分析简单规则和ML模型的误判样本，解释性能差异的来源。

---

#### E9.1 简单规则FP分析

##### FP样本统计

| 指标 | 数值 |
|------|------|
| FP 总数 | 532 |
| FP 场景来源 | benign (100.0%) |
| FP在benign Normal中的占比 | 8.96% |

##### 各场景FP率

| 场景 | Normal样本数 | FP数 | FP率 |
|------|-------------|------|------|
| benign | 5,939 | 532 | **8.96%** |
| ied | 6,298 | 0 | 0.00% |
| scada | 6,411 | 0 | 0.00% |

##### FP样本cwm分布

| 统计量 | FP样本 | TP样本 (Attack) |
|--------|--------|-----------------|
| Mean | 1.95 | 37.01 |
| Std | 0.22 | 198.88 |
| Min | 1 | 1 |
| Max | 2 | 2609 |

FP样本的cwm值分布: 仅有 1 和 2 两种取值

##### FP vs TN vs TP 关键特征对比

| 特征 | FP_mean | FP_std | TN_mean | TN_std | TP_mean | TP_std |
|------|---------|--------|---------|--------|---------|--------|
| consecutive_write_max | 1.95 | 0.22 | 0.00 | 0.00 | 37.01 | 198.97 |
| consecutive_write_mean | 1.93 | 0.24 | 0.00 | 0.00 | 17.02 | 94.48 |
| write_burst_count | 0.00 | 0.00 | 0.00 | 0.00 | 0.37 | 1.80 |
| fc_write_ratio | 0.037 | 0.019 | 0.00 | 0.00 | 0.124 | 0.206 |
| fc_read_ratio | 0.963 | 0.019 | 1.00 | 0.00 | 0.876 | 0.206 |
| packet_count | 91.67 | 5.18 | 61.45 | 27.50 | 142.26 | 442.31 |
| interval_mean | 0.131 | 0.015 | 0.235 | 0.103 | 0.203 | 0.089 |

**发现**:
1. FP样本全部来自benign场景的正常运维操作
2. FP样本的cwm值较低 (1-2)，显著低于TP样本
3. FP样本的`fc_write_ratio`较低，但仍高于TN
4. 简单规则无法区分正常运维中的少量连续写操作和攻击行为

---

#### E9.2 ML模型误判分析

##### Random Forest 性能

| 指标 | 数值 |
|------|------|
| Accuracy | 0.9896 |
| Precision | 0.8550 |
| Recall | 0.9811 |
| F1 | 0.9137 |

**混淆矩阵**:
- TP: 1,091
- FN: 21
- FP: 185
- TN: 18,463

##### XGBoost 性能

| 指标 | 数值 |
|------|------|
| Accuracy | 0.9943 |
| Precision | 0.9111 |
| Recall | 0.9955 |
| F1 | 0.9514 |

**混淆矩阵**:
- TP: 1,107
- FN: 5
- FP: 108
- TN: 18,540

##### RF FN样本分析 (21个漏检)

| 指标 | 数值 |
|------|------|
| 场景来源 | scada (100%) |
| cwm 均值 | 1.86 |
| cwm 范围 | 1-2 |
| 预测概率均值 | 0.3874 |
| 接近决策边界(0.4-0.5)的样本 | 10个 (47.6%) |

##### FN vs TP 关键特征差异 (RF)

| 特征 | FN_mean | TP_mean | 差异% |
|------|---------|---------|-------|
| consecutive_write_max | 1.86 | 37.69 | -95.1% |
| consecutive_write_mean | 1.76 | 17.31 | -89.8% |
| write_burst_count | 0.00 | 0.38 | -100.0% |
| fc_write_ratio | 0.046 | 0.125 | -63.3% |
| packet_count | 91.38 | 143.24 | -36.2% |

**发现**:
1. FN样本的cwm值显著低于TP样本
2. FN样本的预测概率接近决策边界 (0.5)
3. FN样本更像"正常"流量，特征值与Normal样本相近

---

#### E9.3 规则 vs ML 误判对比

##### 误判数量对比

| 方法 | FN | FP | 总误判 |
|------|----|----|--------|
| 简单规则 (cwm>0) | 0 | 532 | 532 |
| Random Forest | 21 | 185 | 206 |
| XGBoost | 5 | 108 | 113 |

##### FP重叠分析 (规则 vs RF)

| 指标 | 数值 |
|------|------|
| 规则FP数 | 532 |
| RF FP数 | 185 |
| 重叠FP数 | 185 |
| RF纠正的FP数 | 347 (65.2%) |
| RF新增FP数 | 0 |

##### FN引入分析

| 指标 | 数值 |
|------|------|
| 规则FN数 | 0 |
| RF FN数 | 21 |
| RF新增FN数 | 21 |

##### RF纠正的FP样本特征

- 场景: 全部来自benign
- cwm均值: 1.93
- 预测概率均值: 0.2719
- 低概率(<0.3)样本: 189个 (54.5%)

##### 综合性能对比

| 方法 | TP | FN | FP | TN | Precision | Recall | F1 |
|------|----|----|----|----|-----------|--------|-----|
| 简单规则 | 1,112 | 0 | 532 | 18,116 | 0.6764 | **1.0000** | 0.8070 |
| RF | 1,091 | 21 | 185 | 18,463 | 0.8550 | 0.9811 | 0.9137 |
| XGBoost | 1,107 | 5 | 108 | 18,540 | **0.9111** | 0.9955 | **0.9514** |

---

## 三、核心发现与结论

### 1. 数据集特性

- **CIC Modbus 2023数据集的攻击模式相对简单**
- 攻击流量与正常流量在`consecutive_write_max`特征上完全可分 (SCADA/IED场景)
- 唯一的混淆来自benign场景的正常运维操作

### 2. 简单规则的价值与局限

**价值**:
- 在SCADA和IED场景达到完美检测 (F1=1.0)
- 零漏检 (Recall=100%)
- 计算开销极低，适合嵌入式部署

**局限**:
- 对benign场景的正常运维操作产生较多误报
- 难以推广到更复杂的攻击模式

### 3. ML方法的价值

- **大幅减少误报**: RF纠正65.2%的FP，XGBoost纠正79.7%
- **维持高检测率**: XGBoost Recall仍达99.55%
- **学习复杂模式**: 利用多特征组合区分正常运维和攻击

### 4. 核心权衡

| 维度 | 简单规则 | ML方法 |
|------|----------|--------|
| Recall | 100% (零漏检) | 99%+ (少量漏检) |
| Precision | 67.6% | 85-91% |
| 计算开销 | 极低 | 较低 |
| 可解释性 | 高 | 中等 |
| 泛化能力 | 有限 | 较强 |

---

## 四、论文支撑价值

### 支撑论点1: 数据集分析
- 证明CIC Modbus 2023数据集的攻击模式相对简单
- 揭示`consecutive_write_max`特征的高区分度本质

### 支撑论点2: 方法对比
- 提供简单规则基线的完整量化评估
- 证明ML方法相对于简单规则的增量价值

### 支撑论点3: 实用建议
- 为不同应用场景提供方法选择指南
- 分析Precision-Recall权衡的实际影响

### 应用场景建议

| 场景 | 推荐方法 | 理由 |
|------|----------|------|
| 关键基础设施 | 简单规则 | 不能容忍任何漏检 |
| 一般监控 | ML (XGBoost) | 平衡检测率和误报率 |
| 高精度需求 | ML + 人工复核 | 减少误报节省人力 |
| 资源受限环境 | 简单规则 | 计算开销最低 |

---

## 五、输出文件列表

### 数据表格
| 文件名 | 描述 |
|--------|------|
| `phase3.5_e13_rule_vs_ml.csv` | E13 规则vs ML对比结果 |
| `phase3.5_e13_scenario_results.csv` | E13 分场景评估结果 |
| `phase3.5_e14_feature_ablation.csv` | E14 特征消融实验结果 |
| `phase3.5_e15_threshold_analysis.csv` | E15 阈值分析结果 |
| `phase3.5_e9_rule_fp_analysis.csv` | E9 规则FP分析 |
| `phase3.5_e9_ml_fn_analysis.csv` | E9 ML FN分析 |
| `phase3.5_e9_error_comparison.csv` | E9 误判综合对比 |

### 可视化图表
| 文件名 | 描述 |
|--------|------|
| `phase3.5_e13_rule_vs_ml.png` | E13 规则vs ML对比图 |
| `phase3.5_e9_fp_analysis.png` | E9 FP样本分析图 |
| `phase3.5_e9_ml_error_analysis.png` | E9 ML误判分析图 |
| `phase3.5_e9_error_comparison.png` | E9 误判对比图 |

### Notebook文件
| 文件名 | 描述 |
|--------|------|
| `10_Phase3.5_补充实验.ipynb` | E13, E14, E15 实验代码 |
| `11_Phase3.5_E9_误判分析.ipynb` | E9 误判分析实验代码 |

---

## 六、总结

Phase 3.5补充实验全面揭示了：

1. **数据集特性**: CIC Modbus 2023数据集的攻击模式可通过单一特征(`consecutive_write_max`)近乎完美识别，体现了数据集的相对简单性

2. **简单规则基线**: `cwm > 0` 规则在特定场景(SCADA/IED)达到完美性能，但在benign场景存在约9%的误报率

3. **ML增量价值**: ML模型的主要价值在于减少误报(65-80%)，而非提升检测率；cwm特征对ML模型的增量贡献仅约0.15%

4. **误判根源**: 
   - FP源于benign场景正常运维中的少量连续写操作
   - FN源于cwm值较低、更像"正常"流量的边缘攻击样本

5. **实践建议**: 根据应用场景的漏检容忍度和误报成本选择合适的检测方法

这些发现为论文提供了坚实的数据支撑，特别是在"数据集分析"和"轻量级实现"方向的定位调整上。
